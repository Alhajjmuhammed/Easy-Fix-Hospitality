{% extends 'system_admin/base.html' %}
{% load static %}
{% load restaurant_tags %}

{% block title %}Manage Products - System Admin{% endblock %}

{% block extra_css %}
<style>
.product-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin-bottom: 15px;
    transition: box-shadow 0.2s;
    background: white;
}

.product-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.product-header {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
}

.product-body {
    padding: 15px;
}

.product-image {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
    margin-right: 15px;
}

.price-badge {
    background-color: #28a745;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-weight: bold;
}

.availability-badge {
    font-size: 0.8em;
}

.restaurant-badge {
    background-color: #6c757d;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.category-badge {
    background-color: #007bff;
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    margin-right: 5px;
}

.filters-card {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
}

/* Product Image Styles */
.product-image {
    width: 50px !important;
    height: 50px !important;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    max-width: 50px !important;
    max-height: 50px !important;
}

.product-table-image {
    width: 50px !important;
    height: 50px !important;
    border-radius: 6px;
    object-fit: cover;
    border: 1px solid #dee2e6;
    max-width: 50px !important;
    max-height: 50px !important;
}

.no-image-placeholder {
    width: 50px !important;
    height: 50px !important;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
}

.no-image-placeholder-card {
    width: 50px !important;
    height: 50px !important;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    flex-shrink: 0;
    margin-right: 10px;
}
    height: 50px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    flex-shrink: 0;
    margin-right: 10px;
}

.current-product-image {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    object-fit: cover;
}

.no-image-placeholder-large {
    width: 200px;
    height: 150px;
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background-color: #f8f9fa;
    color: #6c757d;
}

/* Improve contrast for Bootstrap badge colors */
.badge.bg-info {
    background-color: #0d6efd !important;
    color: white !important;
}

.badge.bg-warning {
    background-color: #f57c00 !important;
    color: white !important;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-utensils"></i> Manage Products</h2>
                    <p class="text-muted">System-wide product management for all restaurants</p>
                </div>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                    <i class="fas fa-plus"></i> Add Product
                </button>
            </div>

            <!-- Search and Filters -->
            <div class="card filters-card mb-4">
                <div class="card-body">
                    <form method="get" class="mb-0">
                        <div class="row g-3">
                            <!-- Search Input -->
                            <div class="col-md-4">
                                <label for="productSearch" class="form-label">
                                    <i class="fas fa-search"></i> Search Products
                                </label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="productSearch" name="search" 
                                           value="{{ search_query }}" placeholder="Search by name, description, category...">
                                    <span class="input-group-text">
                                        <div id="searchSpinner" class="spinner-border spinner-border-sm" role="status" style="display: none;">
                                            <span class="visually-hidden">Searching...</span>
                                        </div>
                                        <i class="fas fa-search" id="searchIcon"></i>
                                    </span>
                                </div>
                                <small class="text-muted">Press ESC to clear search</small>
                            </div>

                            <!-- Restaurant Filter -->
                            <div class="col-md-3">
                                <label for="restaurantFilter" class="form-label">
                                    <i class="fas fa-building"></i> Restaurant
                                </label>
                                <select class="form-select" id="restaurantFilter" name="restaurant">
                                    <option value="">All Restaurants</option>
                                    {% for restaurant in restaurants %}
                                    <option value="{{ restaurant.id }}" {% if request.GET.restaurant == restaurant.id|stringformat:'s' %}selected{% endif %}>
                                        {{ restaurant.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Category Filter -->
                            <div class="col-md-3">
                                <label for="categoryFilter" class="form-label">
                                    <i class="fas fa-tags"></i> Category
                                </label>
                                <select class="form-select" id="categoryFilter" name="category">
                                    <option value="">All Categories</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}" {% if request.GET.category == category.id|stringformat:'s' %}selected{% endif %}>
                                        {{ category.name }}
                                        {% if not selected_restaurant %} ({{ category.owner.restaurant_name }}){% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Availability Filter -->
                            <div class="col-md-2">
                                <label for="availabilityFilter" class="form-label">
                                    <i class="fas fa-check-circle"></i> Status
                                </label>
                                <select class="form-select" id="availabilityFilter" name="availability">
                                    <option value="">All Status</option>
                                    <option value="available" {% if availability_filter == 'available' %}selected{% endif %}>Available</option>
                                    <option value="unavailable" {% if availability_filter == 'unavailable' %}selected{% endif %}>Unavailable</option>
                                </select>
                            </div>
                        </div>

                        <!-- Results Summary and Items Per Page -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div class="text-muted">
                                {% if search_query or request.GET.restaurant or request.GET.category or availability_filter %}
                                    Showing <strong>{{ filtered_count }}</strong> of <strong>{{ total_products }}</strong> products
                                    {% if search_query %}matching "<em>{{ search_query }}</em>"{% endif %}
                                {% else %}
                                    Showing <strong>{{ total_products }}</strong> products total
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-center">
                                <label for="perPageSelect" class="form-label me-2 mb-0">Items per page:</label>
                                <select class="form-select form-select-sm" id="perPageSelect" name="per_page" style="width: auto;">
                                    <option value="5" {% if per_page == 5 %}selected{% endif %}>5</option>
                                    <option value="10" {% if per_page == 10 %}selected{% endif %}>10</option>
                                    <option value="15" {% if per_page == 15 %}selected{% endif %}>15</option>
                                    <option value="20" {% if per_page == 20 %}selected{% endif %}>20</option>
                                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25</option>
                                    <option value="30" {% if per_page == 30 %}selected{% endif %}>30</option>
                                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Hidden fields to preserve pagination -->
                        {% for key, value in request.GET.items %}
                            {% if key != 'page' and key != 'search' and key != 'restaurant' and key != 'category' and key != 'availability' and key != 'per_page' %}
                                <input type="hidden" name="{{ key }}" value="{{ value }}">
                            {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>

            <!-- Products Table -->
            {% if page_obj.object_list %}
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">
                                        <i class="fas fa-hashtag"></i> SN
                                    </th>
                                    <th style="width: 80px;">Image</th>
                                    <th>Product Details</th>
                                    <th>Restaurant</th>
                                    <th>Category</th>
                                    <th>Station</th>
                                    <th>Price</th>
                                    <th>Status</th>
                                    <th style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for product in page_obj.object_list %}
                                <tr>
                                    <td>
                                        <span class="badge bg-secondary">
                                            {{ page_obj.start_index|add:forloop.counter0 }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if product.main_category.image %}
                                        <img src="{{ product.main_category.image.url }}" alt="{{ product.name }}" 
                                             class="product-table-image" 
                                             style="width: 50px; height: 50px; object-fit: cover; border-radius: 6px;">
                                        {% else %}
                                        <div class="no-image-placeholder d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; border: 2px dashed #ccc; border-radius: 6px;">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ product.name }}</strong>
                                            {% if product.description %}
                                            <br><small class="text-muted">{{ product.description|truncatechars:60 }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ product.main_category.owner.restaurant_name }}</span>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>{{ product.main_category.name }}</strong>
                                            {% if product.sub_category %}
                                            <br><small class="text-muted">{{ product.sub_category.name }}</small>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        {% if product.station == 'kitchen' %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-utensils"></i> Kitchen
                                        </span>
                                        {% elif product.station == 'bar' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-wine-glass"></i> Bar
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6">{% currency_symbol %}{{ product.price }}</span>
                                    </td>
                                    <td>
                                        <span class="badge {% if product.is_available %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if product.is_available %}
                                            <i class="fas fa-check"></i> Available
                                            {% else %}
                                            <i class="fas fa-times"></i> Unavailable
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-info" onclick="viewProductDetails({{ product.id }})" 
                                                    title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-warning" onclick="editProduct({{ product.id }})" 
                                                    title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="deleteProduct({{ product.id }}, '{{ product.name }}', '{{ product.main_category.owner.restaurant_name }}')" 
                                                    title="Delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if page_obj.has_other_pages %}
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} products
                </div>
                <nav aria-label="Products pagination">
                    <ul class="pagination mb-0">
                        {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page=1">
                                    <i class="fas fa-angle-double-left"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}">
                                    <i class="fas fa-angle-left"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-angle-left"></i></span>
                            </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                                <li class="page-item active">
                                    <span class="page-link">{{ num }}</span>
                                </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ num }}">{{ num }}</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}">
                                    <i class="fas fa-angle-right"></i>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% for key, value in request.GET.items %}{% if key != 'page' %}{{ key }}={{ value }}&{% endif %}{% endfor %}page={{ page_obj.paginator.num_pages }}">
                                    <i class="fas fa-angle-double-right"></i>
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-angle-right"></i></span>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
            
            {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-utensils fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted">No Products Found</h4>
                    <p class="text-muted">
                        {% if search_query %}
                            No products found matching "<em>{{ search_query }}</em>".
                        {% elif request.GET.restaurant %}
                            No products found for the selected restaurant.
                        {% elif request.GET.category %}
                            No products found in the selected category.
                        {% elif availability_filter %}
                            No {{ availability_filter }} products found.
                        {% else %}
                            No products found in the system.
                        {% endif %}
                    </p>
                    {% if search_query or request.GET.restaurant or request.GET.category or availability_filter %}
                    <a href="{% url 'system_admin:manage_products' %}" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-undo"></i> Clear Filters
                    </a>
                    {% endif %}
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createProductModal">
                        <i class="fas fa-plus"></i> Create First Product
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Create Product Modal -->
<div class="modal fade" id="createProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createProductForm">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="createRestaurant" class="form-label">Restaurant *</label>
                        <select class="form-select" id="createRestaurant" name="restaurant" required onchange="loadMainCategories('create')">
                            <option value="">Select Restaurant</option>
                            {% for restaurant in restaurants %}
                            <option value="{{ restaurant.id }}">{{ restaurant.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createMainCategory" class="form-label">Main Category *</label>
                        <select class="form-select" id="createMainCategory" name="main_category" required onchange="loadSubCategories('create')">
                            <option value="">Select Main Category</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createSubCategory" class="form-label">Sub Category</label>
                        <select class="form-select" id="createSubCategory" name="sub_category">
                            <option value="">Select Sub Category (Optional)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="createName" class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="createName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="createDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="createDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="createPrice" class="form-label">Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">{% currency_symbol %}</span>
                            <input type="number" class="form-control" id="createPrice" name="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="createStation" class="form-label">Station *</label>
                        <select class="form-select" id="createStation" name="station" required>
                            <option value="kitchen">üç¥ Kitchen</option>
                            <option value="bar">üç∏ Bar</option>
                        </select>
                        <div class="form-text">Assign this product to Kitchen or Bar station</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="createAvailability" name="availability" checked>
                            <label class="form-check-label" for="createAvailability">
                                Available for ordering
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editProductForm">
                {% csrf_token %}
                <input type="hidden" id="editProductId" name="product_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Restaurant</label>
                        <input type="text" class="form-control" id="editRestaurantName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Main Category</label>
                        <input type="text" class="form-control" id="editMainCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sub Category</label>
                        <input type="text" class="form-control" id="editSubCategoryName" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editName" class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="editName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="editPrice" class="form-label">Price *</label>
                        <div class="input-group">
                            <span class="input-group-text">{% currency_symbol %}</span>
                            <input type="number" class="form-control" id="editPrice" name="price" step="0.01" min="0" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editStation" class="form-label">Station *</label>
                        <select class="form-select" id="editStation" name="station" required>
                            <option value="kitchen">üç¥ Kitchen</option>
                            <option value="bar">üç∏ Bar</option>
                        </select>
                        <div class="form-text">Assign this product to Kitchen or Bar station</div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editAvailability" name="availability">
                            <label class="form-check-label" for="editAvailability">
                                Available for ordering
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Product Details Modal -->
<div class="modal fade" id="productDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="productDetailsContent">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Real-time search functionality
let searchTimeout;
const searchInput = document.getElementById('productSearch');
const searchSpinner = document.getElementById('searchSpinner');
const searchIcon = document.getElementById('searchIcon');

if (searchInput) {
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchSpinner.style.display = 'inline-block';
        searchIcon.style.display = 'none';
        
        searchTimeout = setTimeout(() => {
            const currentUrl = new URL(window.location.href);
            const searchValue = this.value.trim();
            
            if (searchValue) {
                currentUrl.searchParams.set('search', searchValue);
            } else {
                currentUrl.searchParams.delete('search');
            }
            
            // Reset to page 1 for new search
            currentUrl.searchParams.delete('page');
            
            window.location.href = currentUrl.toString();
        }, 500);
    });

    // ESC key to clear search
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            this.value = '';
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.delete('search');
            currentUrl.searchParams.delete('page');
            window.location.href = currentUrl.toString();
        }
    });
}

// Auto-submit forms for filters and pagination
document.addEventListener('DOMContentLoaded', function() {
    // Auto-submit restaurant filter
    const restaurantFilter = document.getElementById('restaurantFilter');
    if (restaurantFilter) {
        restaurantFilter.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    // Auto-submit category filter
    const categoryFilter = document.getElementById('categoryFilter');
    if (categoryFilter) {
        categoryFilter.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    // Auto-submit availability filter
    const availabilityFilter = document.getElementById('availabilityFilter');
    if (availabilityFilter) {
        availabilityFilter.addEventListener('change', function() {
            this.form.submit();
        });
    }
    
    // Auto-submit per_page selector
    const perPageSelect = document.getElementById('perPageSelect');
    if (perPageSelect) {
        perPageSelect.addEventListener('change', function() {
            this.form.submit();
        });
    }
});

// Filter functions (legacy support)
function filterByRestaurant() {
    const restaurantId = document.getElementById('restaurantFilter').value;
    const currentUrl = new URL(window.location.href);
    
    if (restaurantId) {
        currentUrl.searchParams.set('restaurant', restaurantId);
    } else {
        currentUrl.searchParams.delete('restaurant');
    }
    currentUrl.searchParams.delete('category'); // Reset category filter
    
    window.location.href = currentUrl.toString();
}

function filterByCategory() {
    const categoryId = document.getElementById('categoryFilter').value;
    const currentUrl = new URL(window.location.href);
    
    if (categoryId) {
        currentUrl.searchParams.set('category', categoryId);
    } else {
        currentUrl.searchParams.delete('category');
    }
    
    window.location.href = currentUrl.toString();
}

// Load main categories based on restaurant selection
async function loadMainCategories(prefix) {
    const restaurantId = document.getElementById(`${prefix}Restaurant`).value;
    const mainCategorySelect = document.getElementById(`${prefix}MainCategory`);
    const subCategorySelect = document.getElementById(`${prefix}SubCategory`);
    
    // Clear existing options
    mainCategorySelect.innerHTML = '<option value="">Select Main Category</option>';
    subCategorySelect.innerHTML = '<option value="">Select Sub Category (Optional)</option>';
    
    if (!restaurantId) return;
    
    try {
        const response = await fetch(`{% url "system_admin:get_categories" 0 %}`.replace('0', restaurantId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const result = await response.json();
        
        if (result.success) {
            result.categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                mainCategorySelect.appendChild(option);
            });
        } else {
            console.error('Failed to load categories:', result.message);
            showAlert('warning', 'Could not load categories: ' + result.message);
        }
    } catch (error) {
        console.error('Error loading categories:', error);
        showAlert('warning', 'Could not load categories: ' + error.message);
    }
}

// Load subcategories based on main category selection
async function loadSubCategories(prefix) {
    const categoryId = document.getElementById(`${prefix}MainCategory`).value;
    const subCategorySelect = document.getElementById(`${prefix}SubCategory`);
    
    // Clear existing options
    subCategorySelect.innerHTML = '<option value="">Select Sub Category (Optional)</option>';
    
    if (!categoryId) return;
    
    try {
        const response = await fetch(`{% url "system_admin:get_subcategories" 0 %}`.replace('0', categoryId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const result = await response.json();
        
        if (result.success) {
            result.subcategories.forEach(subcategory => {
                const option = document.createElement('option');
                option.value = subcategory.id;
                option.textContent = subcategory.name;
                subCategorySelect.appendChild(option);
            });
        } else {
            console.error('Failed to load subcategories:', result.message);
        }
    } catch (error) {
        console.error('Error loading subcategories:', error);
        showAlert('warning', 'Could not load subcategories: ' + error.message);
    }
}

// Create product
document.getElementById('createProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = {
        main_category: formData.get('main_category'),
        sub_category: formData.get('sub_category') || null,
        name: formData.get('name'),
        description: formData.get('description'),
        price: formData.get('price'),
        station: formData.get('station'),
        availability: formData.has('availability')
    };
    
    try {
        const response = await fetch('{% url "system_admin:create_product" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('createProductModal')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error creating product: ' + error.message);
    }
});

// Edit product
async function editProduct(productId) {
    try {
        const response = await fetch(`{% url "system_admin:edit_product" 0 %}`.replace('0', productId));
        
        // Check if the response is ok
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const textResponse = await response.text();
            console.error('Expected JSON but got:', textResponse);
            throw new Error('Server returned non-JSON response');
        }
        
        const data = await response.json();
        
        // Check if the response has the expected structure
        if (!data.id) {
            throw new Error('Invalid product data received');
        }
        
        document.getElementById('editProductId').value = data.id;
        document.getElementById('editName').value = data.name;
        document.getElementById('editDescription').value = data.description;
        document.getElementById('editPrice').value = data.price;
        document.getElementById('editStation').value = data.station || 'kitchen';
        document.getElementById('editAvailability').checked = data.availability;
        document.getElementById('editRestaurantName').value = data.restaurant_name;
        document.getElementById('editMainCategoryName').value = data.main_category_name;
        document.getElementById('editSubCategoryName').value = data.sub_category_name || 'None';
        
        new bootstrap.Modal(document.getElementById('editProductModal')).show();
    } catch (error) {
        console.error('Edit product error:', error);
        showAlert('danger', 'Error loading product data: ' + error.message);
    }
}

document.getElementById('editProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productId = document.getElementById('editProductId').value;
    const formData = new FormData(this);
    const data = {
        name: formData.get('name'),
        description: formData.get('description'),
        price: formData.get('price'),
        station: formData.get('station'),
        availability: formData.has('availability')
    };
    
    try {
        const response = await fetch(`{% url "system_admin:edit_product" 0 %}`.replace('0', productId), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error updating product: ' + error.message);
    }
});

// Delete product
async function deleteProduct(productId, productName, restaurantName) {
    if (!confirm(`Are you sure you want to delete the product "${productName}" from ${restaurantName}?\n\nThis action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`{% url "system_admin:delete_product" 0 %}`.replace('0', productId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('success', result.message);
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert('danger', result.message);
        }
    } catch (error) {
        showAlert('danger', 'Error deleting product: ' + error.message);
    }
}

// View product details
async function viewProductDetails(productId) {
    try {
        const response = await fetch(`{% url "system_admin:product_details" 0 %}`.replace('0', productId));
        const html = await response.text();
        
        document.getElementById('productDetailsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('productDetailsModal')).show();
    } catch (error) {
        showAlert('danger', 'Error loading product details: ' + error.message);
    }
}

// View switching function
function switchView(viewType) {
    const cardView = document.getElementById('cardViewContainer');
    const tableView = document.getElementById('tableViewContainer');
    const cardBtn = document.getElementById('cardView');
    const tableBtn = document.getElementById('tableView');
    
    if (viewType === 'card') {
        cardView.style.display = 'flex';
        tableView.style.display = 'none';
        cardBtn.classList.add('active');
        tableBtn.classList.remove('active');
    } else {
        cardView.style.display = 'none';
        tableView.style.display = 'block';
        tableBtn.classList.add('active');
        cardBtn.classList.remove('active');
    }
}

// Alert function
function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}
</script>
{% endblock %}