{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Printer Settings - {% if current_restaurant %}{{ current_restaurant.name }}{% else %}{{ owner.restaurant_name }}{% endif %}{% endblock %}

{% block page_title %}Printer Settings{% endblock %}
{% block page_description %}Configure your thermal printers for kitchen, bar, and receipts{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-print"></i> Printer Configuration
                        {% if current_restaurant %}
                            - {{ current_restaurant.name }}
                            {% if not current_restaurant.is_main_restaurant %}
                                <span class="badge bg-info ms-2">Branch</span>
                            {% endif %}
                        {% endif %}
                    </h4>
                    <small>Configure different printers for kitchen orders, bar orders, and receipts</small>
                </div>
                <div class="card-body">
                    
                    {% if current_restaurant %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Settings for:</strong> {{ current_restaurant.name }}
                        {% if not current_restaurant.is_main_restaurant %}
                            (Branch)
                        {% else %}
                            (Main Restaurant)
                        {% endif %}
                        <br>
                        <small>These printer settings are independent for each restaurant/branch.</small>
                    </div>
                    {% endif %}
                    
                    <!-- Print Client Info -->
                    <div class="alert alert-warning mb-4">
                        <h5><i class="fas fa-info-circle"></i> How Printing Works</h5>
                        <p class="mb-2">This system uses a <strong>Print Client</strong> application that runs on your Windows PC where printers are connected.</p>
                        <ol class="mb-2">
                            <li>Enter your printer names below (you can find them in Windows: Control Panel → Devices and Printers)</li>
                            <li>Download and run the Print Client on your Windows PC</li>
                            <li>Configure the Print Client with your API Token (shown below)</li>
                            <li>The Print Client will automatically print orders to your configured printers</li>
                        </ol>
                        <p class="mb-0"><strong>To find printer names on Windows:</strong> Open Command Prompt and run: <code>wmic printer get name</code></p>
                    </div>

                    <!-- API Token Section -->
                    <div class="mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-key"></i> Print Client API Token</h5>
                            </div>
                            <div class="card-body">
                                <p class="text-muted">Use this token in your Print Client <code>config.json</code> file:</p>
                                
                                <div class="input-group mb-3">
                                    <input type="text" 
                                           id="api_token" 
                                           class="form-control font-monospace" 
                                           value="{{ api_token|default:'Token not generated' }}" 
                                           readonly>
                                    <button class="btn btn-outline-secondary" type="button" onclick="copyToken()">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <button type="button" class="btn btn-warning" onclick="regenerateToken()">
                                        <i class="fas fa-sync-alt"></i> Regenerate Token
                                    </button>
                                    <small class="text-muted">
                                        <i class="fas fa-exclamation-triangle"></i> 
                                        Regenerating will invalidate the old token
                                    </small>
                                </div>
                                
                                <hr>
                                <h6>Print Client Configuration Example:</h6>
                                <pre class="bg-dark text-light p-3 rounded"><code>{
    "server_url": "https://hospitality.easyfixsoft.com",
    "api_token": "{{ api_token|default:'YOUR_TOKEN_HERE' }}",
    "poll_interval": 5
}</code></pre>
                                
                                <hr>
                                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div>
                                        <h6 class="mb-1"><i class="fas fa-download text-success"></i> Download Print Client</h6>
                                        <small class="text-muted">Windows application - No Python installation required</small>
                                    </div>
                                    <a href="{% static 'downloads/PrintClient_Windows.zip' %}" 
                                       class="btn btn-success" 
                                       download>
                                        <i class="fas fa-download"></i> Download PrintClient.zip (15 MB)
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detect Printers Section (for Print Client users) -->
                    <div class="mb-4">
                        <div class="card border-secondary">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-print"></i> Printer Detection</h5>
                            </div>
                            <div class="card-body">
                                <p>To detect printers connected to your Windows PC:</p>
                                <ol>
                                    <li>Open <strong>Command Prompt</strong> on your Windows PC</li>
                                    <li>Run: <code>wmic printer get name</code></li>
                                    <li>Copy the printer name and paste it in the fields below</li>
                                </ol>
                                <p class="text-muted mb-0"><small>Example printer names: "EPSON TM-T20II", "POS-80", "Receipt Printer"</small></p>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <form id="printerSettingsForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Kitchen Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="kitchen_printer" class="form-label">
                                    <i class="fas fa-utensils text-danger"></i> Kitchen Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="kitchen_printer" 
                                       name="kitchen_printer" 
                                       value="{{ kitchen_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Kitchen Order Tickets (KOT)</small>
                            </div>

                            <!-- Bar Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="bar_printer" class="form-label">
                                    <i class="fas fa-cocktail text-info"></i> Bar Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="bar_printer" 
                                       name="bar_printer" 
                                       value="{{ bar_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Bar Order Tickets (BOT)</small>
                            </div>

                            <!-- Buffet Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="buffet_printer" class="form-label">
                                    <i class="fas fa-utensils text-warning"></i> Buffet Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="buffet_printer" 
                                       name="buffet_printer" 
                                       value="{{ buffet_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Buffet Order Tickets (BUFFET)</small>
                            </div>

                            <!-- Service Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="service_printer" class="form-label">
                                    <i class="fas fa-concierge-bell text-primary"></i> Service Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="service_printer" 
                                       name="service_printer" 
                                       value="{{ service_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Service Order Tickets (SERVICE)</small>
                            </div>

                            <!-- Receipt Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="receipt_printer" class="form-label">
                                    <i class="fas fa-receipt text-success"></i> Receipt Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="receipt_printer" 
                                       name="receipt_printer" 
                                       value="{{ receipt_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For payment receipts</small>
                            </div>
                        </div>

                        <!-- Auto-Print Settings -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5><i class="fas fa-cog"></i> Auto-Print Settings</h5>
                                <hr>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_kot" 
                                           name="auto_print_kot"
                                           {% if auto_print_kot %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_kot">
                                        <strong>Auto-print Kitchen Orders (KOT)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_bot" 
                                           name="auto_print_bot"
                                           {% if auto_print_bot %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_bot">
                                        <strong>Auto-print Bar Orders (BOT)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_buffet" 
                                           name="auto_print_buffet"
                                           {% if auto_print_buffet %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_buffet">
                                        <strong>Auto-print Buffet Orders (BUFFET)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_service" 
                                           name="auto_print_service"
                                           {% if auto_print_service %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_service">
                                        <strong>Auto-print Service Orders (SERVICE)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Printer Settings
                            </button>
                            <a href="{% url 'admin_panel:admin_dashboard' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>

                    <!-- Current Configuration Preview -->
                    <div class="mt-5">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-eye"></i> Current Configuration</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <th width="200">Kitchen Printer:</th>
                                        <td>{{ kitchen_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Bar Printer:</th>
                                        <td>{{ bar_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Receipt Printer:</th>
                                        <td>{{ receipt_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Auto-print KOT:</th>
                                        <td>
                                            {% if auto_print_kot %}
                                                <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Auto-print BOT:</th>
                                        <td>
                                            {% if auto_print_bot %}
                                                <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Save Settings
    document.getElementById('printerSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "admin_panel:save_printer_settings" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            // Check if response is OK before parsing JSON
            if (!response.ok) {
                return response.text().then(text => {
                    throw new Error(`Server error (${response.status}): ${text.substring(0, 100)}`);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('✓ ' + data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Save settings error:', error);
            alert('Error saving settings: ' + error.message);
        });
    });
    
});

// Copy API token to clipboard
function copyToken() {
    const tokenInput = document.getElementById('api_token');
    tokenInput.select();
    document.execCommand('copy');
    alert('✓ API Token copied to clipboard!');
}

// Regenerate API token
function regenerateToken() {
    if (!confirm('Are you sure you want to regenerate the API token?\n\nThis will invalidate your current token and you will need to update your Print Client config.json file.')) {
        return;
    }
    
    fetch('{% url "admin_panel:regenerate_api_token" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('api_token').value = data.token;
            alert('✓ ' + data.message);
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error regenerating token: ' + error);
    });
}
</script>
{% endblock %}
