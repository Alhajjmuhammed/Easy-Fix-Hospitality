{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Printer Settings - {% if current_restaurant %}{{ current_restaurant.name }}{% else %}{{ owner.restaurant_name }}{% endif %}{% endblock %}

{% block page_title %}Printer Settings{% endblock %}
{% block page_description %}Configure your thermal printers for kitchen, bar, and receipts{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-print"></i> Printer Configuration
                        {% if current_restaurant %}
                            - {{ current_restaurant.name }}
                            {% if not current_restaurant.is_main_restaurant %}
                                <span class="badge bg-info ms-2">Branch</span>
                            {% endif %}
                        {% endif %}
                    </h4>
                    <small>Configure different printers for kitchen orders, bar orders, and receipts</small>
                </div>
                <div class="card-body">
                    
                    {% if current_restaurant %}
                    <div class="alert alert-info mb-4">
                        <i class="fas fa-info-circle"></i>
                        <strong>Settings for:</strong> {{ current_restaurant.name }}
                        {% if not current_restaurant.is_main_restaurant %}
                            (Branch)
                        {% else %}
                            (Main Restaurant)
                        {% endif %}
                        <br>
                        <small>These printer settings are independent for each restaurant/branch.</small>
                    </div>
                    {% endif %}
                    
                    <!-- Detect Printers Button -->
                    <div class="mb-4">
                        <button type="button" class="btn btn-success" id="detectPrintersBtn">
                            <i class="fas fa-search"></i> Detect Available Printers
                        </button>
                        <small class="text-muted ml-2">Click to see all printers connected to this computer</small>
                    </div>

                    <!-- Available Printers List -->
                    <div id="availablePrinters" class="mb-4" style="display:none;">
                        <div class="card border-success">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-list"></i> Available Printers</h5>
                            </div>
                            <div class="card-body">
                                <div id="printerList"></div>
                                <small class="text-muted">Click on a printer name to copy it</small>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <form id="printerSettingsForm">
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Kitchen Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="kitchen_printer" class="form-label">
                                    <i class="fas fa-utensils text-danger"></i> Kitchen Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="kitchen_printer" 
                                       name="kitchen_printer" 
                                       value="{{ kitchen_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Kitchen Order Tickets (KOT)</small>
                            </div>

                            <!-- Bar Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="bar_printer" class="form-label">
                                    <i class="fas fa-cocktail text-info"></i> Bar Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="bar_printer" 
                                       name="bar_printer" 
                                       value="{{ bar_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For Bar Order Tickets (BOT)</small>
                            </div>

                            <!-- Receipt Printer -->
                            <div class="col-md-4 mb-3">
                                <label for="receipt_printer" class="form-label">
                                    <i class="fas fa-receipt text-success"></i> Receipt Printer
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="receipt_printer" 
                                       name="receipt_printer" 
                                       value="{{ receipt_printer }}"
                                       placeholder="Leave blank for auto-detect">
                                <small class="form-text text-muted">For payment receipts</small>
                            </div>
                        </div>

                        <!-- Auto-Print Settings -->
                        <div class="row mt-3">
                            <div class="col-12">
                                <h5><i class="fas fa-cog"></i> Auto-Print Settings</h5>
                                <hr>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_kot" 
                                           name="auto_print_kot"
                                           {% if auto_print_kot %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_kot">
                                        <strong>Auto-print Kitchen Orders (KOT)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="auto_print_bot" 
                                           name="auto_print_bot"
                                           {% if auto_print_bot %}checked{% endif %}>
                                    <label class="form-check-label" for="auto_print_bot">
                                        <strong>Auto-print Bar Orders (BOT)</strong>
                                        <br><small class="text-muted">Automatically print when order is placed</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save"></i> Save Printer Settings
                            </button>
                            <a href="{% url 'admin_panel:admin_dashboard' %}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                        </div>
                    </form>

                    <!-- Current Configuration Preview -->
                    <div class="mt-5">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h5 class="mb-0"><i class="fas fa-eye"></i> Current Configuration</h5>
                            </div>
                            <div class="card-body">
                                <table class="table table-sm">
                                    <tr>
                                        <th width="200">Kitchen Printer:</th>
                                        <td>{{ kitchen_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Bar Printer:</th>
                                        <td>{{ bar_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Receipt Printer:</th>
                                        <td>{{ receipt_printer|default:"<em>Auto-detect</em>" }}</td>
                                    </tr>
                                    <tr>
                                        <th>Auto-print KOT:</th>
                                        <td>
                                            {% if auto_print_kot %}
                                                <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    <tr>
                                        <th>Auto-print BOT:</th>
                                        <td>
                                            {% if auto_print_bot %}
                                                <span class="badge bg-success">Enabled</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Disabled</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // Detect Printers
    document.getElementById('detectPrintersBtn').addEventListener('click', function() {
        const btn = this;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detecting...';
        
        fetch('{% url "admin_panel:detect_printers" %}', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Detect Available Printers';
                
                if (data.success && data.printers.length > 0) {
                    let html = '<div class="list-group">';
                    data.printers.forEach((printer, index) => {
                        let defaultBadge = printer.is_default ? '<span class="badge bg-primary ms-2">DEFAULT</span>' : '';
                        html += `
                            <a href="#" class="list-group-item list-group-item-action printer-item" data-printer="${printer.name}">
                                <i class="fas fa-print"></i> ${printer.name} ${defaultBadge}
                            </a>
                        `;
                    });
                    html += '</div>';
                    html += `<div class="alert alert-success mt-2 mb-0">Found ${data.printers.length} printer(s)</div>`;
                    
                    document.getElementById('printerList').innerHTML = html;
                    document.getElementById('availablePrinters').style.display = 'block';
                    
                    // Add click to copy functionality
                    document.querySelectorAll('.printer-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            e.preventDefault();
                            const printerName = this.dataset.printer;
                            
                            // Copy to clipboard
                            navigator.clipboard.writeText(printerName).then(() => {
                                // Show which field to paste into
                                alert(`Printer "${printerName}" copied!\n\nPaste it into Kitchen, Bar, or Receipt Printer field.`);
                            });
                        });
                    });
                    
                } else if (data.success && data.printers.length === 0) {
                    document.getElementById('printerList').innerHTML = '<div class="alert alert-warning mb-0">No printers found on this system.</div>';
                    document.getElementById('availablePrinters').style.display = 'block';
                } else {
                    document.getElementById('printerList').innerHTML = `<div class="alert alert-danger mb-0">${data.error || 'Unknown error'}</div>`;
                    document.getElementById('availablePrinters').style.display = 'block';
                }
            })
            .catch(error => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-search"></i> Detect Available Printers';
                document.getElementById('printerList').innerHTML = `<div class="alert alert-danger mb-0">Error detecting printers: ${error.message}</div>`;
                document.getElementById('availablePrinters').style.display = 'block';
            });
    });
    
    // Save Settings
    document.getElementById('printerSettingsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        fetch('{% url "admin_panel:save_printer_settings" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('âœ“ ' + data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error saving settings: ' + error);
        });
    });
    
});
</script>
{% endblock %}
