{% extends 'admin_panel/base.html' %}
{% load static %}

{% block title %}Select Restaurant{% endblock %}

{% block extra_css %}
<style>
    .restaurant-selector {
        max-width: 100%;
        margin: 0;
        padding: 10px 5px;
    }
    
    .restaurant-card {
        border: 1px solid #e9ecef;
        border-radius: 6px;
        transition: all 0.2s ease;
        cursor: pointer;
        background: white;
        box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        margin-bottom: 10px;
        height: 100%;
    }
    
    .restaurant-card:hover {
        border-color: #667eea;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }
    
    .restaurant-card.selected {
        border-color: #28a745;
        background: linear-gradient(135deg, #f8fff9 0%, #e8f5e8 100%);
        box-shadow: 0 2px 6px rgba(40, 167, 69, 0.15);
    }
    
    .restaurant-card .card-body {
        padding: 12px 15px;
    }
    
    .main-restaurant {
        border-left: 3px solid #007bff;
    }
    
    .branch-restaurant {
        border-left: 3px solid #28a745;
    }
    
    .all-restaurants {
        border-left: 3px solid #6f42c1;
        background: linear-gradient(135deg, #f8f6ff 0%, #ede8ff 100%);
    }
    
    .restaurant-status {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 10px;
        font-weight: 500;
        display: inline-block;
        margin-top: 3px;
    }
    
    .status-main {
        background: #007bff;
        color: white;
    }
    
    .status-branch {
        background: #28a745;
        color: white;
    }
    
    .status-all {
        background: #6f42c1;
        color: white;
    }
    
    .header-section {
        text-align: center;
        margin-bottom: 15px;
        padding: 10px 0;
    }
    
    .header-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 10px;
        color: white;
        font-size: 1.2rem;
    }
    
    .header-section h2 {
        font-size: 1.5rem;
        margin-bottom: 3px;
        font-weight: 600;
    }
    
    .header-section p {
        margin-bottom: 0;
        font-size: 0.85rem;
    }
    
    .restaurant-meta {
        color: #6c757d;
        font-size: 0.75rem;
        margin-top: 5px;
        line-height: 1.3;
    }
    
    .restaurant-meta div {
        margin-bottom: 1px;
    }
    
    .restaurant-stats {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 8px;
        margin-top: 8px;
    }
    
    .stat-item {
        text-align: center;
        padding: 2px;
    }
    
    .stat-number {
        font-size: 1.1rem;
        font-weight: bold;
        color: #495057;
        display: block;
        line-height: 1;
    }
    
    .stat-label {
        font-size: 0.65rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        margin-top: 1px;
    }
    
    .current-selection {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        border-radius: 4px;
        padding: 8px 12px;
        margin-bottom: 12px;
        text-align: center;
    }
    
    .current-selection h6 {
        margin-bottom: 3px;
        font-size: 0.8rem;
    }
    
    .btn-select {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        color: white;
        padding: 6px 15px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        width: 100%;
        margin-top: 8px;
    }
    
    .btn-select:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        color: white;
    }
    
    .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 3px;
        line-height: 1.2;
    }
    
    .card-text {
        font-size: 0.8rem;
        line-height: 1.3;
        margin-bottom: 6px;
    }
    
    .restaurant-info h5 {
        margin-bottom: 5px;
    }
    
    .action-buttons {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #e9ecef;
        text-align: center;
    }
    
    .action-buttons .btn {
        margin: 0 4px;
        padding: 6px 15px;
        border-radius: 4px;
        font-size: 0.8rem;
    }
    
    /* Reduce row margins - very tight like dashboard */
    .row.restaurant-grid {
        margin-left: -3px;
        margin-right: -3px;
    }
    
    .row.restaurant-grid > [class*="col-"] {
        padding-left: 3px;
        padding-right: 3px;
    }
    
    /* Match dashboard compactness */
    .d-flex.justify-content-between {
        margin-bottom: 5px;
    }
    
    .fa-lg {
        font-size: 1rem !important;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .restaurant-selector {
            padding: 8px 3px;
        }
        
        .header-section {
            margin-bottom: 10px;
            padding: 8px 0;
        }
        
        .restaurant-card .card-body {
            padding: 10px 12px;
        }
        
        .current-selection {
            padding: 6px 8px;
            margin-bottom: 8px;
        }
        
        .row.restaurant-grid > [class*="col-"] {
            margin-bottom: 8px;
            padding-left: 2px;
            padding-right: 2px;
        }
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid restaurant-selector">
    <!-- Header Section -->
    <div class="header-section">
        <div class="header-icon">
            <i class="fas fa-store"></i>
        </div>
        <h2>Select Restaurant</h2>
        <p class="text-muted">Choose which restaurant location you want to manage</p>
    </div>

    <!-- Current Selection -->
    {% if current_restaurant %}
    <div class="current-selection">
        <h6 class="mb-2">
            <i class="fas fa-check-circle text-success"></i> Currently Selected
        </h6>
        <strong>{{ current_restaurant.name }}</strong>
        {% if current_restaurant.is_main_restaurant %}
            <span class="restaurant-status status-main ml-2">Main Restaurant</span>
        {% else %}
            <span class="restaurant-status status-branch ml-2">Branch</span>
        {% endif %}
    </div>
    {% elif request.session.view_all_restaurants %}
    <div class="current-selection">
        <h6 class="mb-2">
            <i class="fas fa-check-circle text-success"></i> Currently Selected
        </h6>
        <strong>All Restaurants</strong>
        <span class="restaurant-status status-all ml-2">Consolidated View</span>
    </div>
    {% endif %}

    <!-- Restaurant Options -->
    <div class="row restaurant-grid">
        <!-- All Restaurants Option (for main owners) -->
        {% if show_all_option %}
        <div class="col-lg-4 col-md-6">
            <div class="card restaurant-card all-restaurants" onclick="selectAllRestaurants()">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">
                                <i class="fas fa-globe text-purple me-2"></i>
                                All Restaurants
                            </h5>
                            <span class="restaurant-status status-all">Consolidated View</span>
                        </div>
                        <i class="fas fa-chart-line fa-lg text-purple opacity-50"></i>
                    </div>
                    
                    <p class="card-text">
                        View combined data from all your restaurant locations for 
                        consolidated reporting and analytics.
                    </p>
                    
                    <div class="restaurant-stats">
                        <div class="row">
                            <div class="col-6 stat-item">
                                <span class="stat-number">{{ restaurants.count }}</span>
                                <span class="stat-label">Total Locations</span>
                            </div>
                            <div class="col-6 stat-item">
                                <span class="stat-number">{{ restaurants|length|add:"-1" }}</span>
                                <span class="stat-label">Branches</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-select">
                        <i class="fas fa-chart-bar me-1"></i> View All Data
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Individual Restaurants -->
        {% for restaurant in restaurants %}
        <div class="col-lg-4 col-md-6">
            <div class="card restaurant-card {% if restaurant.is_main_restaurant %}main-restaurant{% else %}branch-restaurant{% endif %} 
                        {% if current_restaurant and current_restaurant.id == restaurant.id %}selected{% endif %}"
                 onclick="selectRestaurant({{ restaurant.id }}, '{{ restaurant.name|escapejs }}')">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="card-title">
                                {% if restaurant.is_main_restaurant %}
                                    <i class="fas fa-star text-warning me-2"></i>
                                {% else %}
                                    <i class="fas fa-code-branch text-success me-2"></i>
                                {% endif %}
                                {{ restaurant.name }}
                            </h5>
                            <span class="restaurant-status {% if restaurant.is_main_restaurant %}status-main{% else %}status-branch{% endif %}">
                                {% if restaurant.is_main_restaurant %}Main Restaurant{% else %}Branch{% endif %}
                            </span>
                        </div>
                        {% if restaurant.is_main_restaurant %}
                            <i class="fas fa-building fa-lg text-primary opacity-50"></i>
                        {% else %}
                            <i class="fas fa-store fa-lg text-success opacity-50"></i>
                        {% endif %}
                    </div>
                    
                    {% if restaurant.description %}
                    <p class="card-text">{{ restaurant.description|truncatechars:80 }}</p>
                    {% endif %}
                    
                    <div class="restaurant-meta">
                        {% if restaurant.address %}
                            <div>
                                <i class="fas fa-map-marker-alt me-1"></i> {{ restaurant.address|truncatechars:40 }}
                            </div>
                        {% endif %}
                        
                        <div>
                            <i class="fas fa-user me-1"></i> 
                            <strong>Owner:</strong> {{ restaurant.branch_owner.get_full_name|default:restaurant.branch_owner.username }}
                        </div>
                        
                        <div>
                            <i class="fas fa-percentage me-1"></i> 
                            <strong>Tax:</strong> {{ restaurant.tax_rate_percentage|floatformat:1 }}%
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div class="restaurant-stats">
                        <div class="row">
                            <div class="col-4 stat-item">
                                <span class="stat-number">--</span>
                                <span class="stat-label">Today's Orders</span>
                            </div>
                            <div class="col-4 stat-item">
                                <span class="stat-number">--</span>
                                <span class="stat-label">Tables</span>
                            </div>
                            <div class="col-4 stat-item">
                                <span class="stat-number">{{ restaurant.get_products_count|default:"--" }}</span>
                                <span class="stat-label">Products</span>
                            </div>
                        </div>
                    </div>
                    
                    <button class="btn btn-select">
                        <i class="fas fa-arrow-right me-1"></i> Select Location
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <a href="{% url 'admin_panel:admin_dashboard' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
        </a>
        <a href="{% url 'admin_panel:manage_branches' %}" class="btn btn-outline-primary">
            <i class="fas fa-cog me-1"></i> Manage Branches
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function selectRestaurant(restaurantId, restaurantName) {
    console.log('DEBUG: selectRestaurant called with restaurantId=' + restaurantId + ', restaurantName=' + restaurantName);
    
    // Create a safe selector by using attribute selectors instead of onclick text matching
    var buttonSelector = `[onclick*="selectRestaurant(${restaurantId},"] .btn-select`;
    
    // Show loading state
    $(buttonSelector).html('<i class="fas fa-spinner fa-spin"></i> Switching...');
    
    console.log('DEBUG: Making AJAX request to switch_restaurant with data:', {
        'restaurant_id': restaurantId,
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
    });
    
    $.ajax({
        url: '{% url "admin_panel:switch_restaurant" %}',
        type: 'POST',
        data: {
            'restaurant_id': restaurantId,
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(data) {
            console.log('DEBUG: AJAX success response:', data);
            if (data.success) {
                // Show success message
                showSuccessMessage(data.message);
                
                // Use redirect URL from server response
                var redirectUrl = data.redirect_url || '/admin-panel/main-owner-dashboard/';
                
                console.log('DEBUG: Redirecting to:', redirectUrl);
                
                // Redirect after short delay
                setTimeout(function() {
                    window.location.href = redirectUrl;
                }, 1000);
            } else {
                console.log('DEBUG: Server returned error:', data.error);
                showErrorMessage('Error: ' + data.error);
                // Reset button using the same safe selector
                $(buttonSelector).html('<i class="fas fa-arrow-right"></i> Select Location');
            }
        },
        error: function(xhr, status, error) {
            console.log('DEBUG: AJAX error - xhr:', xhr, 'status:', status, 'error:', error);
            showErrorMessage('An error occurred while switching restaurant.');
            // Reset button using the same safe selector
            $(buttonSelector).html('<i class="fas fa-arrow-right"></i> Select Location');
        }
    });
}

function selectAllRestaurants() {
    // Show loading state
    $('.all-restaurants .btn-select').html('<i class="fas fa-spinner fa-spin"></i> Switching...');
    
    $.ajax({
        url: '{% url "admin_panel:set_view_all_restaurants" %}',
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(data) {
            if (data.success) {
                // Show success message
                showSuccessMessage(data.message);
                
                // Redirect to main owner dashboard for better branch overview
                setTimeout(function() {
                    window.location.href = '{% url "admin_panel:main_owner_dashboard" %}';
                }, 1000);
            } else {
                showErrorMessage('Error: ' + data.error);
                // Reset button
                $('.all-restaurants .btn-select').html('<i class="fas fa-chart-bar"></i> View All Data');
            }
        },
        error: function() {
            showErrorMessage('An error occurred while switching to all restaurants view.');
            // Reset button
            $('.all-restaurants .btn-select').html('<i class="fas fa-chart-bar"></i> View All Data');
        }
    });
}

function showSuccessMessage(message) {
    $('<div class="alert alert-success alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
        '<i class="fas fa-check-circle"></i> ' + message +
        '<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>' +
        '</div>').appendTo('body');
}

function showErrorMessage(message) {
    $('<div class="alert alert-danger alert-dismissible fade show" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">' +
        '<i class="fas fa-exclamation-circle"></i> ' + message +
        '<button type="button" class="close" data-dismiss="alert"><span>&times;</span></button>' +
        '</div>').appendTo('body');
}

// Auto-hide alerts after 5 seconds
setTimeout(function() {
    $('.alert').fadeOut();
}, 5000);

// Add visual feedback for card selection
$('.restaurant-card').hover(
    function() {
        $(this).find('.btn-select').addClass('btn-primary').removeClass('btn-outline-primary');
    },
    function() {
        $(this).find('.btn-select').removeClass('btn-primary').addClass('btn-outline-primary');
    }
);
</script>
{% endblock %}